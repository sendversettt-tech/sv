<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>SendVerse</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #020617 100%);
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .shell {
      width: 100%;
      max-width: 1160px;
      background: linear-gradient(140deg, rgba(15,23,42,0.98), rgba(15,23,42,0.98));
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.3);
      box-shadow: 0 40px 90px rgba(0,0,0,0.75);
      overflow: hidden;
    }

    .header {
      padding: 18px 22px;
      border-bottom: 1px solid rgba(51,65,85,0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: radial-gradient(circle at top left, rgba(59,130,246,0.35), transparent 60%);
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-badge {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 25% 20%, #38bdf8, #1d4ed8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 700;
      color: white;
      box-shadow: 0 12px 30px rgba(37,99,235,0.7);
    }
    .logo-text-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    .logo-text-sub {
      font-size: 11px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .header-right {
      text-align: right;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.7);
      color: #e5e7eb;
      font-size: 11px;
    }
    .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.2);
    }
    .user-label {
      font-size: 11px;
      color: #9ca3af;
    }
    .user-label span {
      color: #e5e7eb;
      font-weight: 500;
    }

    .body {
      display: flex;
      min-height: 420px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
    }
    .btn-header {
      background: rgba(15,23,42,0.85);
      color: #e5e7eb;
      border: 1px solid rgba(75,85,99,1);
      padding: 6px 12px;
    }
    .btn-header:hover {
      transform: translateY(-1px);
      border-color: #e5e7eb;
    }
    .btn-primary {
      background: linear-gradient(to right, #22c55e, #22d3ee);
      color: #020617;
      box-shadow: 0 16px 30px rgba(34,197,94,0.5);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 20px 40px rgba(34,197,94,0.6);
    }
    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      border: 1px solid rgba(75,85,99,1);
    }
    .btn-secondary:hover {
      transform: translateY(-1px);
      border-color: #e5e7eb;
    }
    .btn-ghost {
      background: transparent;
      color: #9ca3af;
      border: 1px solid rgba(75,85,99,0.9);
    }
    .btn-ghost:hover {
      color: #e5e7eb;
      border-color: #e5e7eb;
      transform: translateY(-1px);
    }

    .small {
      font-size: 11px;
      color: #9ca3af;
    }
    .small code {
      font-size: 11px;
    }
    .error {
      margin-top: 8px;
      font-size: 12px;
      color: #f97373;
    }
    .hidden { display: none !important; }

    /* LOGIN SCREEN */
    #login-screen {
      width: 100%;
      padding: 26px 26px 30px;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .login-card {
      width: 100%;
      max-width: 360px;
      background: radial-gradient(circle at top left, rgba(59,130,246,0.23), rgba(15,23,42,0.97));
      border-radius: 18px;
      padding: 22px 20px 18px;
      border: 1px solid rgba(37,99,235,0.7);
      box-shadow: 0 22px 40px rgba(15,23,42,0.85);
    }
    .login-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .login-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 12px;
      color: #e5e7eb;
      margin-top: 10px;
    }
    input[type="text"],
    input[type="password"],
    input[type="number"],
    input[type="file"],
    textarea,
    select {
      width: 100%;
      margin-top: 4px;
      padding: 8px 10px;
      border-radius: 9px;
      border: 1px solid rgba(55,65,81,0.9);
      background-color: rgba(15,23,42,0.98);
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
      transition: border 0.14s ease, box-shadow 0.14s ease, background-color 0.14s ease;
    }
    input::placeholder,
    textarea::placeholder {
      color: #6b7280;
    }
    input:focus,
    textarea:focus,
    select:focus {
      border-color: #38bdf8;
      box-shadow: 0 0 0 1px rgba(56,189,248,0.85);
      background-color: rgba(15,23,42,1);
    }
    textarea {
      resize: vertical;
      min-height: 120px;
      max-height: 260px;
    }
    input[type="file"] {
      padding: 5px 0;
    }

    /* DASHBOARD */
    #dashboard {
      display: none;
      width: 100%;
    }
    .dashboard-inner {
      display: grid;
      grid-template-columns: 220px minmax(0, 1fr);
      min-height: 420px;
    }
    @media (max-width: 880px) {
      .dashboard-inner {
        grid-template-columns: 1fr;
      }
    }

    .sidebar {
      border-right: 1px solid rgba(31,41,55,0.9);
      background: linear-gradient(to bottom, rgba(15,23,42,0.98), rgba(15,23,42,1));
      padding: 18px 12px 18px;
    }
    .nav-title {
      font-size: 11px;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      margin-bottom: 10px;
    }
    .nav-item {
      width: 100%;
      text-align: left;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: transparent;
      color: #9ca3af;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      margin-bottom: 6px;
      transition: background 0.12s ease, border 0.12s ease, color 0.12s ease;
    }
    .nav-item span {
      font-weight: 500;
    }
    .nav-item small {
      font-size: 11px;
      color: #6b7280;
    }
    .nav-item.active {
      background: radial-gradient(circle at top left, rgba(59,130,246,0.35), rgba(15,23,42,1));
      color: #f9fafb;
      border-color: rgba(59,130,246,0.9);
    }
    .nav-footer {
      margin-top: 18px;
      padding-top: 12px;
      border-top: 1px dashed rgba(55,65,81,0.9);
      font-size: 11px;
      color: #9ca3af;
    }

    .main {
      padding: 18px 20px;
    }
    .view {
      display: none;
    }
    .view.active {
      display: block;
    }
    .view-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .view-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-bottom: 14px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(31,41,55,0.7), rgba(15,23,42,0.98));
      border-radius: 14px;
      padding: 12px 12px 10px;
      border: 1px solid rgba(55,65,81,0.9);
      margin-bottom: 12px;
    }
    .flex-row {
      display: flex;
      gap: 10px;
    }
    .flex-row > div {
      flex: 1;
    }

    .stats-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }
    @media (max-width: 880px) {
      .stats-row {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    .stat-card {
      border-radius: 10px;
      padding: 6px 8px;
      background: rgba(15,23,42,0.98);
      border: 1px solid rgba(55,65,81,0.9);
      font-size: 11px;
    }
    .stat-label {
      color: #9ca3af;
      margin-bottom: 2px;
    }
    .stat-value {
      font-size: 16px;
      font-weight: 600;
    }
    .stat-good { color: #4ade80; }
    .stat-bad { color: #fb7185; }

    .log-box {
      margin-top: 8px;
      padding: 8px;
      border-radius: 10px;
      background: rgba(15,23,42,0.98);
      border: 1px dashed rgba(75,85,99,1);
      max-height: 170px;
      overflow-y: auto;
      font-size: 11px;
      white-space: pre-line;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 4px;
    }
    th, td {
      padding: 6px 6px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: left;
    }
    th {
      font-weight: 500;
      color: #9ca3af;
    }
    tr:hover td {
      background: rgba(15,23,42,0.95);
      cursor: pointer;
    }
    .badge-status {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,1);
      display: inline-block;
    }
    .badge-status.running {
      border-color: #38bdf8;
      color: #38bdf8;
    }
    .badge-status.finished {
      border-color: #4ade80;
      color: #4ade80;
    }
    .badge-status.stopped {
      border-color: #f97373;
      color: #f97373;
    }
    .badge-status.queued {
      border-color: #eab308;
      color: #eab308;
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="header">
      <div class="logo">
        <div class="logo-badge">SV</div>
        <div>
          <div class="logo-text-title">SendVerse</div>
          <div class="logo-text-sub">SMTP based campaign engine</div>
        </div>
      </div>
      <div class="header-right">
        <div class="pill">
          <div class="dot"></div>
          <span>Send via your own SMTP &amp; SES</span>
        </div>
        <div class="user-label" id="user-label">
          Not logged in
        </div>
        <button class="btn btn-header hidden" id="logout_btn">Logout</button>
      </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen">
      <div class="login-card">
        <div class="login-title">Sign in</div>
        <div class="login-sub">
          Enter the username &amp; password created for you by the provider.
        </div>
        <label>Username
          <input type="text" id="login_username" placeholder="e.g. client1" autocomplete="username" />
        </label>
        <label>Password
          <input type="password" id="login_password" placeholder="••••••••" autocomplete="current-password" />
        </label>
        <button class="btn btn-primary" id="login_btn">Continue</button>
        <div id="login_error" class="error hidden"></div>
        <div class="small" style="margin-top:10px;">
          Contact Administrator for new access.
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard">
      <div class="dashboard-inner">
        <div class="sidebar">
          <div class="nav-title">Navigation</div>
          <button class="nav-item active" data-view="smtp">
            <span>SMTP profiles</span>
            <small id="smtp_count_label">0 saved</small>
          </button>
          <button class="nav-item" data-view="create">
            <span>Create campaign</span>
            <small>Use saved SMTP</small>
          </button>
          <button class="nav-item" data-view="campaigns">
            <span>My campaigns</span>
            <small id="campaign_count_label">0 total</small>
          </button>

          <div class="nav-footer">
            SMTP stays with each user’s own provider.<br/>
            Respect SES limits to avoid blocks.
          </div>
        </div>

        <div class="main">
          <!-- SMTP VIEW -->
          <div class="view active" id="view-smtp">
            <div class="view-title">SMTP profiles</div>
            <div class="view-sub">
              Save SMTP credentials locally in your browser. Not shared with other users.
            </div>

            <div class="card">
              <div class="small" style="margin-bottom:6px;">New / edit SMTP profile</div>
              <label>Profile name
                <input type="text" id="smtp_profile_name" placeholder="e.g. Main SES AP-SOUTH-1" />
              </label>
              <label>Host
                <input type="text" id="smtp_host" placeholder="email-smtp.ap-south-1.amazonaws.com" />
              </label>
              <div class="flex-row">
                <div>
                  <label>Port
                    <input type="number" id="smtp_port" value="587" />
                  </label>
                </div>
                <div>
                  <label>Use TLS
                    <div style="margin-top:6px;">
                      <input type="checkbox" id="smtp_use_tls" checked />
                      <span class="small">Recommended</span>
                    </div>
                  </label>
                </div>
              </div>
              <label>SMTP username
                <input type="text" id="smtp_username" placeholder="SMTP username from SES" />
              </label>
              <label>SMTP password
                <input type="password" id="smtp_password" placeholder="SMTP password from SES" />
              </label>
              <label>From email
                <input type="text" id="from_email" placeholder="verified@yourdomain.com" />
              </label>

              <button class="btn btn-primary" id="save_smtp_btn">Save profile</button>
            </div>

            <div class="card">
              <div class="small" style="margin-bottom:4px;">Saved profiles</div>
              <table>
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Host</th>
                    <th>From email</th>
                  </tr>
                </thead>
                <tbody id="smtp_table_body">
                  <tr><td colspan="3" class="small" style="padding-top:6px;">No profiles yet.</td></tr>
                </tbody>
              </table>
              <div class="small" style="margin-top:6px;">
                Tip: click a row to load it into the form.
              </div>
            </div>
          </div>

          <!-- CREATE CAMPAIGN VIEW -->
          <div class="view" id="view-create">
            <div class="view-title">Create campaign</div>
            <div class="view-sub">
              Choose an SMTP profile, upload a CSV, and control sending speed.
            </div>

            <div class="card">
  <label>SMTP profile
    <select id="create_smtp_select">
      <option value="">Select saved profile…</option>
    </select>
  </label>

  <label>Subject
    <input type="text" id="subject" placeholder="e.g. Welcome to our newsletter" />
  </label>

  <label>HTML body</label>
  <textarea id="html_body" placeholder="Hi {{name}},&#10;&#10>Welcome!"></textarea>
  <div class="small" style="margin-top:4px;">
    Use <code>{{name}}</code> and <code>{{email}}</code> for personalization.
  </div>

  <div class="flex-row">
    <div>
      <label>Speed (emails per minute)
        <input type="number" id="speed_per_minute" value="60" />
      </label>
    </div>
    <div>
      <label>Contacts CSV
        <input type="file" id="contacts_file" accept=".csv" />
      </label>
    </div>
  </div>

  <!-- TOS CONSENT -->
  <div class="small" style="margin-top:8px; display:flex; gap:8px; align-items:flex-start;">
    <input type="checkbox" id="tos_checkbox" style="margin-top:3px;" />
    <label for="tos_checkbox" style="margin:0;">
      <strong>I agree to the sending terms.</strong><br/>
      By starting this campaign I confirm that I have permission to email these recipients,
      that I will not send unsolicited or illegal spam, and that I am solely responsible
      for the content and consequences of this campaign.
    </label>
  </div>

  <details class="small" style="margin-top:6px;">
    <summary>View full sending terms</summary>
    <ul style="margin-top:6px; padding-left:18px;">
      <li>You use your own SMTP / email service (such as AWS SES). <strong>SendVerse</strong> only provides the software interface.</li>
      <li>You will comply with all applicable anti-spam, privacy and data-protection laws and your SMTP provider’s policies.</li>
      <li>You will only send to recipients who have valid consent or another lawful basis to receive your emails.</li>
      <li>You will not send phishing, scams, malware, hate, or any other illegal or abusive content.</li>
      <li>You are fully responsible for your content, your lists and the consequences of your sending.</li>
      <li>Your SMTP provider may limit, block or terminate your account if you violate their rules; <strong>SendVerse</strong> is not responsible for such actions.</li>
      <li><strong>SendVerse</strong> may suspend access if it reasonably believes its service is being used for spam or abuse.</li>
      <li>No delivery is guaranteed; deliverability depends on your provider, reputation and recipient mailbox rules.</li>
    </ul>
  </details>

  <button class="btn btn-primary" id="start_campaign_btn">Start campaign</button>
</div>


            <div class="card">
              <div class="small">Active campaign analytics</div>
              <label>Active campaign ID
                <input type="text" id="active_campaign_id" placeholder="Will be filled when you start a campaign" />
              </label>

              <div class="stats-row">
                <div class="stat-card">
                  <div class="stat-label">Total</div>
                  <div class="stat-value" id="stat_total">0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Processed</div>
                  <div class="stat-value" id="stat_processed">0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Delivered</div>
                  <div class="stat-value stat-good" id="stat_delivered">0</div>
                </div>
                <div class="stat-card">
                  <div class="stat-label">Bounced / failed</div>
                  <div class="stat-value stat-bad" id="stat_bounced">0</div>
                </div>
              </div>

              <div style="margin-top:8px; display:flex; gap:8px;">
                <button class="btn btn-secondary" id="refresh_active_btn">Refresh analytics</button>
                <button class="btn btn-ghost" id="stop_active_btn">Stop active campaign</button>
              </div>

              <div class="log-box" id="log_box">
                Waiting for campaign…
              </div>
            </div>
          </div>

          <!-- CAMPAIGNS VIEW -->
          <div class="view" id="view-campaigns">
            <div class="view-title">My campaigns</div>
            <div class="view-sub">
              List of campaigns started during this server session. Click a row to load analytics.
            </div>

            <div class="card">
              <div class="small" style="margin-bottom:4px;">Campaigns</div>
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Subject</th>
                    <th>Status</th>
                    <th>Total</th>
                    <th>Delivered</th>
                    <th>Failed</th>
                  </tr>
                </thead>
                <tbody id="campaigns_table_body">
                  <tr><td colspan="6" class="small" style="padding-top:6px;">No campaigns yet.</td></tr>
                </tbody>
              </table>
              <div style="margin-top:6px;">
                <button class="btn btn-secondary" id="refresh_campaigns_btn">Refresh list</button>
              </div>
            </div>
          </div>

        </div> <!-- main -->
      </div> <!-- dashboard-inner -->
    </div> <!-- dashboard -->
  </div>

  <script>
    const AUTH_STORAGE_KEY = "sv_auth";

    let AUTH_HEADER = null;
    let CURRENT_USER = null;
    let CAMPAIGN_POLL_TIMER = null;

    function setLoggedIn(user) {
      CURRENT_USER = user;
      document.getElementById("user-label").innerHTML = 'Logged in as <span>' + user + '</span>';
      document.getElementById("login-screen").classList.add("hidden");
      document.getElementById("dashboard").style.display = "block";
      document.getElementById("logout_btn").classList.remove("hidden");

      loadSmtpProfiles();
      loadCampaignsTable();
    }

    function setLoggedOut() {
      CURRENT_USER = null;
      AUTH_HEADER = null;
      if (CAMPAIGN_POLL_TIMER) {
        clearInterval(CAMPAIGN_POLL_TIMER);
        CAMPAIGN_POLL_TIMER = null;
      }
      localStorage.removeItem(AUTH_STORAGE_KEY);
      document.getElementById("user-label").textContent = "Not logged in";
      document.getElementById("logout_btn").classList.add("hidden");
      document.getElementById("dashboard").style.display = "none";
      document.getElementById("login-screen").classList.remove("hidden");
      document.getElementById("login_password").value = "";
      clearError();
      // reset some UI
      document.getElementById("log_box").textContent = "Waiting for campaign…";
      document.getElementById("campaigns_table_body").innerHTML =
        '<tr><td colspan="6" class="small" style="padding-top:6px;">No campaigns yet.</td></tr>';
    }

    function showError(msg) {
      const el = document.getElementById("login_error");
      el.textContent = msg;
      el.classList.remove("hidden");
    }

    function clearError() {
      const el = document.getElementById("login_error");
      el.textContent = "";
      el.classList.add("hidden");
    }

    function switchView(view) {
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      document.getElementById("view-" + view).classList.add("active");
      document.querySelectorAll(".nav-item").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.view === view);
      });
    }

    function logLine(text, replace=false) {
      const box = document.getElementById("log_box");
      if (replace) {
        box.textContent = text + "\n";
      } else {
        if (box.textContent.trim() === "Waiting for campaign…") {
          box.textContent = "";
        }
        box.textContent += text + "\n";
        box.scrollTop = box.scrollHeight;
      }
    }

    function getStorageKey(prefix) {
      return prefix + "_" + (CURRENT_USER || "anon");
    }

    // ====== AUTH PERSISTENCE ======
    function saveAuth(username, token) {
      localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify({ username, token }));
    }

    async function tryAutoLogin() {
      const saved = localStorage.getItem(AUTH_STORAGE_KEY);
      if (!saved) return;
      let parsed;
      try { parsed = JSON.parse(saved); } catch { return; }
      if (!parsed.username || !parsed.token) return;

      AUTH_HEADER = "Basic " + parsed.token;
      try {
        const res = await fetch("/me", {
          headers: { "Authorization": AUTH_HEADER }
        });
        const data = await res.json();
        if (!res.ok) {
          setLoggedOut();
          return;
        }
        // fill username visually (password left empty for security)
        document.getElementById("login_username").value = parsed.username;
        setLoggedIn(data.user);
      } catch (e) {
        setLoggedOut();
      }
    }

    // ====== LOGIN ======
    document.getElementById("login_btn").addEventListener("click", async () => {
      clearError();
      const u = document.getElementById("login_username").value.trim();
      const p = document.getElementById("login_password").value;
      if (!u || !p) {
        showError("Please enter both username and password.");
        return;
      }
      const token = btoa(u + ":" + p);
      AUTH_HEADER = "Basic " + token;

      try {
        const res = await fetch("/me", {
          headers: { "Authorization": AUTH_HEADER }
        });
        const data = await res.json();
        if (!res.ok) {
          AUTH_HEADER = null;
          showError(data.detail || "Invalid credentials.");
          return;
        }
        saveAuth(u, token);
        setLoggedIn(data.user);
      } catch (e) {
        AUTH_HEADER = null;
        showError("Login request failed: " + e.toString());
      }
    });

    // ====== LOGOUT BUTTON ======
    document.getElementById("logout_btn").addEventListener("click", () => {
      setLoggedOut();
    });

    // ====== SIDEBAR NAV ======
    document.querySelectorAll(".nav-item").forEach(btn => {
      btn.addEventListener("click", () => {
        const view = btn.dataset.view;
        switchView(view);
      });
    });

    // ====== SMTP PROFILES (localStorage) ======
    function loadSmtpProfiles() {
      const key = getStorageKey("sv_smtp_profiles");
      const raw = localStorage.getItem(key);
      let profiles = [];
      if (raw) {
        try { profiles = JSON.parse(raw); } catch {}
      }
      renderSmtpProfiles(profiles);
      populateSmtpSelect(profiles);
    }

    function saveSmtpProfiles(profiles) {
      const key = getStorageKey("sv_smtp_profiles");
      localStorage.setItem(key, JSON.stringify(profiles));
      renderSmtpProfiles(profiles);
      populateSmtpSelect(profiles);
    }

    function renderSmtpProfiles(profiles) {
      const tbody = document.getElementById("smtp_table_body");
      tbody.innerHTML = "";
      if (!profiles.length) {
        tbody.innerHTML = '<tr><td colspan="3" class="small" style="padding-top:6px;">No profiles yet.</td></tr>';
      } else {
        profiles.forEach((p, idx) => {
          const tr = document.createElement("tr");
          tr.dataset.index = idx;
          tr.innerHTML = `
            <td>${p.name || "(no name)"}</td>
            <td>${p.host}</td>
            <td>${p.from_email}</td>
          `;
          tr.addEventListener("click", () => {
            document.getElementById("smtp_profile_name").value = p.name || "";
            document.getElementById("smtp_host").value = p.host || "";
            document.getElementById("smtp_port").value = p.port || 587;
            document.getElementById("smtp_use_tls").checked = !!p.use_tls;
            document.getElementById("smtp_username").value = p.username || "";
            document.getElementById("smtp_password").value = p.password || "";
            document.getElementById("from_email").value = p.from_email || "";
          });
          tbody.appendChild(tr);
        });
      }
      document.getElementById("smtp_count_label").textContent = profiles.length + " saved";
    }

    function populateSmtpSelect(profiles) {
      const sel = document.getElementById("create_smtp_select");
      sel.innerHTML = '<option value="">Select saved profile…</option>';
      profiles.forEach((p, idx) => {
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = p.name || ("Profile " + (idx + 1));
        sel.appendChild(opt);
      });
    }

    document.getElementById("save_smtp_btn").addEventListener("click", () => {
      const name = document.getElementById("smtp_profile_name").value.trim();
      const host = document.getElementById("smtp_host").value.trim();
      const port = parseInt(document.getElementById("smtp_port").value || "587", 10);
      const use_tls = document.getElementById("smtp_use_tls").checked;
      const username = document.getElementById("smtp_username").value.trim();
      const password = document.getElementById("smtp_password").value;
      const from_email = document.getElementById("from_email").value.trim();
      if (!host || !from_email) {
        alert("Host and From email are required.");
        return;
      }
      const key = getStorageKey("sv_smtp_profiles");
      const raw = localStorage.getItem(key);
      let profiles = [];
      if (raw) {
        try { profiles = JSON.parse(raw); } catch {}
      }
      profiles.push({ name, host, port, use_tls, username, password, from_email });
      saveSmtpProfiles(profiles);
      alert("SMTP profile saved.");
    });

    document.getElementById("create_smtp_select").addEventListener("change", () => {
      const idx = document.getElementById("create_smtp_select").value;
      if (!idx) return;
      const key = getStorageKey("sv_smtp_profiles");
      const raw = localStorage.getItem(key);
      if (!raw) return;
      let profiles = [];
      try { profiles = JSON.parse(raw); } catch {}
      const p = profiles[parseInt(idx, 10)];
      if (!p) return;
      document.getElementById("smtp_host").value = p.host || "";
      document.getElementById("smtp_port").value = p.port || 587;
      document.getElementById("smtp_use_tls").checked = !!p.use_tls;
      document.getElementById("smtp_username").value = p.username || "";
      document.getElementById("smtp_password").value = p.password || "";
      document.getElementById("from_email").value = p.from_email || "";
    });

    // ====== CAMPAIGN LIST ======
    function loadCampaignsTable() {
      if (!AUTH_HEADER) return;
      fetch("/campaigns", {
        headers: { "Authorization": AUTH_HEADER }
      }).then(r => r.json())
        .then(data => {
          renderCampaignsTable(data);
        }).catch(err => {
          console.error(err);
        });
    }

    function renderCampaignsTable(camps) {
      const tbody = document.getElementById("campaigns_table_body");
      tbody.innerHTML = "";
      if (!camps || !camps.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="small" style="padding-top:6px;">No campaigns yet.</td></tr>';
      } else {
        camps.forEach(c => {
          const tr = document.createElement("tr");
          const cls = "badge-status " + (c.status || "queued");
          tr.innerHTML = `
            <td>${c.campaign_id}</td>
            <td>${c.subject || ""}</td>
            <td><span class="${cls}">${c.status}</span></td>
            <td>${c.total}</td>
            <td>${c.delivered}</td>
            <td>${c.bounced}</td>
          `;
          tr.addEventListener("click", () => {
            document.getElementById("active_campaign_id").value = c.campaign_id;
            switchView("create");
            refreshActiveAnalytics();
          });
          tbody.appendChild(tr);
        });
      }
      document.getElementById("campaign_count_label").textContent = (camps || []).length + " total";
    }

    document.getElementById("refresh_campaigns_btn").addEventListener("click", () => {
      loadCampaignsTable();
    });

    // ====== START CAMPAIGN ======
    document.getElementById("start_campaign_btn").addEventListener("click", async () => {
      if (!AUTH_HEADER || !CURRENT_USER) {
        alert("Please login first.");
        return;
      }
      const subject = document.getElementById("subject").value.trim();
      const htmlBody = document.getElementById("html_body").value;
      const smtpHost = document.getElementById("smtp_host").value.trim();
      const smtpPort = document.getElementById("smtp_port").value;
      const smtpUser = document.getElementById("smtp_username").value.trim();
      const smtpPass = document.getElementById("smtp_password").value;
      const smtpUseTls = document.getElementById("smtp_use_tls").checked;
      const fromEmail = document.getElementById("from_email").value.trim();
      const speed = document.getElementById("speed_per_minute").value || "60";
      const fileInput = document.getElementById("contacts_file");
      if (!fileInput.files[0]) {
        alert("Please choose a CSV file.");
        return;
      }
      if (!subject || !htmlBody || !smtpHost || !fromEmail) {
        alert("Please fill SMTP host, from email, subject, and HTML body.");
        return;
      }
        // NEW: enforce acceptance of SendVerse sending terms
  const tosCheckbox = document.getElementById("tos_checkbox");
  if (!tosCheckbox || !tosCheckbox.checked) {
    alert("To start a campaign, you must agree to the SendVerse sending terms.");
    return;
  }

      const formData = new FormData();
      formData.append("subject", subject);
      formData.append("html_body", htmlBody);
      formData.append("smtp_host", smtpHost);
      formData.append("smtp_port", smtpPort);
      formData.append("smtp_username", smtpUser);
      formData.append("smtp_password", smtpPass);
      formData.append("smtp_use_tls", smtpUseTls ? "true" : "false");
      formData.append("from_email", fromEmail);
      formData.append("speed_per_minute", speed);
      formData.append("contacts_file", fileInput.files[0]);

      try {
        logLine("Starting campaign...", true);
        const res = await fetch("/start_campaign", {
          method: "POST",
          headers: { "Authorization": AUTH_HEADER },
          body: formData
        });
        const data = await res.json();
        if (!res.ok) {
          logLine("Error: " + (data.detail || JSON.stringify(data)));
          return;
        }
        logLine("Campaign started. ID: " + data.campaign_id + " | total: " + data.total_contacts);
        document.getElementById("active_campaign_id").value = data.campaign_id;
        document.getElementById("stat_total").textContent = data.total_contacts;
        document.getElementById("stat_processed").textContent = "0";
        document.getElementById("stat_delivered").textContent = "0";
        document.getElementById("stat_bounced").textContent = "0";

        loadCampaignsTable();
        if (CAMPAIGN_POLL_TIMER) clearInterval(CAMPAIGN_POLL_TIMER);
        CAMPAIGN_POLL_TIMER = setInterval(refreshActiveAnalytics, 8000);
      } catch (e) {
        logLine("Request failed: " + e.toString());
      }
    });

    // ====== ACTIVE ANALYTICS ======
    async function refreshActiveAnalytics() {
      const cid = document.getElementById("active_campaign_id").value.trim();
      if (!cid) {
        logLine("No active campaign ID set.", true);
        return;
      }
      try {
        const res = await fetch("/campaign_status/" + encodeURIComponent(cid), {
          headers: { "Authorization": AUTH_HEADER }
        });
        const data = await res.json();
        if (!res.ok) {
          logLine("Error: " + (data.detail || JSON.stringify(data)));
          return;
        }
        document.getElementById("stat_total").textContent = data.total;
        document.getElementById("stat_processed").textContent = data.processed;
        document.getElementById("stat_delivered").textContent = data.delivered;
        document.getElementById("stat_bounced").textContent = data.bounced;
        const line = "Status: " + data.status +
                     " | Processed: " + data.processed + "/" + data.total +
                     " | Delivered: " + data.delivered +
                     " | Bounced/Failed: " + data.bounced +
                     (data.last_error ? " | Last error: " + data.last_error : "");
        logLine(line);
        if (data.status === "finished" || data.status === "stopped") {
          if (CAMPAIGN_POLL_TIMER) {
            clearInterval(CAMPAIGN_POLL_TIMER);
            CAMPAIGN_POLL_TIMER = null;
          }
        }
        loadCampaignsTable();
      } catch (e) {
        logLine("Request failed: " + e.toString());
      }
    }

    document.getElementById("refresh_active_btn").addEventListener("click", () => {
      refreshActiveAnalytics();
    });

    document.getElementById("stop_active_btn").addEventListener("click", async () => {
      const cid = document.getElementById("active_campaign_id").value.trim();
      if (!cid) {
        alert("Enter active campaign ID first.");
        return;
      }
      try {
        const res = await fetch("/stop_campaign/" + encodeURIComponent(cid), {
          method: "POST",
          headers: { "Authorization": AUTH_HEADER }
        });
        const data = await res.json();
        if (!res.ok) {
          logLine("Error: " + (data.detail || JSON.stringify(data)));
          return;
        }
        logLine("Stop requested for campaign: " + data.campaign_id);
      } catch (e) {
        logLine("Request failed: " + e.toString());
      }
    });

    // ====== AUTO-LOGIN ON PAGE LOAD ======
    window.addEventListener("load", () => {
      tryAutoLogin();
    });
  </script>
</body>
</html>
